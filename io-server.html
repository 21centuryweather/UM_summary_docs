
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>IO server &#8212; Unified Model Summary Documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'io-server';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Lateral Boundary Conditions" href="lbc.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="introduction.html">
  
  
  
  
  
  
    <p class="title logo__title">Unified Model Summary Documentation</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="introduction.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="understanding.html">Understanding the UM</a></li>
<li class="toctree-l1"><a class="reference internal" href="code.html">Code management and structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="using.html">Using the UM</a></li>
<li class="toctree-l1"><a class="reference internal" href="lbc.html">Lateral Boundary Conditions</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">IO server</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/21centuryweather/UM_summary_docs" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/21centuryweather/UM_summary_docs/issues/new?title=Issue%20on%20page%20%2Fio-server.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/io-server.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>IO server</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#architecture">Architecture</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">IO Server</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lookup-tables-and-buffering-fieldsfiles">Lookup tables and buffering fieldsfiles</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design">Design</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#components">Components</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-flow">Data flow</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">Configuration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#general-requirements">General requirements</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ioscntl-namelist"><code class="docutils literal notranslate"><span class="pre">IOSCNTL</span></code> namelist</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#output-files">Output files</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-guide">Setup Guide</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#domain-restrictions">Domain restrictions</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="io-server">
<h1>IO server<a class="headerlink" href="#io-server" title="Link to this heading">#</a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>UM data flow is unidirectional. Data is written to an IO channel as an integer represented data stream. To bypass bottlenecks created by MPI rank zero (<em>R_0</em>, the first process in a parallel application), handling all preprocessing an IO, a sub-model is implemented using IO server processes (IOS) designed to reduce disk latency. This sub-model responds to requests from the atmosphere sub-model.</p>
</section>
<section id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Link to this heading">#</a></h2>
<p>Scaling of parallel applications is limited by several components: load imbalance, serial computing time, communications time and synchronisation frequency.</p>
<p>Operations such as the gather in STASH handling contributes to each of these, the imbalance arising from the larger communications workload of the gathering PE, serial time from the packing
and actual IO, and the large frequencies of these operations.  The serial components are offloaded to a dedicated IO server, deferring synchronisation for as long as possible. A limit of ‘in flight operations’ is created to best compromised between resource usage and performance. This limit is sufficiently high so the first operation completes before the limit is reached.</p>
<p>The IO server implements a coupling protocol that is buffered at the sending and receiving (gathering) sides of the operation. The receive side buffering on the IO sever exploits its queue-like nature.</p>
<p>The sending side has two dispatch queue structures. The first is a simple ring buffer, with strict in-order semantics used solely by <em>R_0</em>. The second queue is used by all tasks <em>R_i</em> for cases where output data is domain decomposed - model fields intended for STASH or dump output channels. This queue is dispatched in-order only with regards to a particular output channel, and each queue element is designed to aggregate (cache) operations destined for the same file. Each queue state can be ‘part-filled’. Queue items are dispatched only when needed and request for a new queue resource will attempt to find any completed queue item that can be reused. Hence the use pattern of the second queue is non-deterministic b/w identical runs, and between ranks in the same run.</p>
<p>The goal is to separate at both send and receive sides the time between initiating block message transmission and completion.</p>
</section>
<section id="id1">
<h2>IO Server<a class="headerlink" href="#id1" title="Link to this heading">#</a></h2>
<p>The IOS comprises multiple tasks decomposing the logical data stream space (similar to Fortran unit numbers), where each task implements a FIFO operational queue. A client API enables a sub-model to insert operations into the queue. A typical client request contains a control message describing the operation (metadata) and, if required, a payload message containing data associated with the operation. A STASH/dump operational has extra parts, as the ‘payload’ is an extended metadata block describing the operations required to describe the STASH request containing similar data. Since the STASH mechanism can aggregate field levels into a single request, the metadata comprises a list of records of arbitrary number and length.</p>
<p>Other than a global exception, the IOS cannot provide information back to the client sub-model. This ensures asynchroneity, but raises issues with error-handling.</p>
</section>
<section id="lookup-tables-and-buffering-fieldsfiles">
<h2>Lookup tables and buffering fieldsfiles<a class="headerlink" href="#lookup-tables-and-buffering-fieldsfiles" title="Link to this heading">#</a></h2>
<p>UM Fieldsfiles contain a fixed length header (<em>H</em>), fixed length index/lookup records (<em>I</em>) and variable length data fields (<em>D</em>).
<em><p style="text-align:center;">H,I_1, I_2,… I_N,D_1,D_2,..,D_N</p></em>
Data is written in numeric order over the course of execution. <em>H</em> is written at the start, the <em>I_1, D_1</em> is generated followed by <em>I_2, D_2</em> etc. To minimise file pointer movement the model writes <em>D_i</em> immediately but buffers <em>I_i</em> in <em>R_0</em> internal memory until the file is closed or explicitly synchronised. The bufferring is done within the <code class="docutils literal notranslate"><span class="pre">model_file</span></code> object which is flushed to disk as needed. This caching model creates problems, as the IO server has minimal knowledge of STASH and other parameters.</p>
<p>To resolve this, the <code class="docutils literal notranslate"><span class="pre">model_file</span></code>’s data structures are replicated b/w <em>R_0</em> and the IOS task responsible for that Fortan unit. <em>R_0</em> never sees a complete record. When <em>R_0</em> is instructed to flush the <em>I_1..I_N</em> table, the <em>R_0</em> copy is sent to the appropriate IOS which merges it with its own, ensuring a complete record prior to data being committed to disk.</p>
<p>Dump outputs are deterministic as the final disk sizes and location are know.</p>
</section>
<section id="design">
<h2>Design<a class="headerlink" href="#design" title="Link to this heading">#</a></h2>
<section id="components">
<h3>Components<a class="headerlink" href="#components" title="Link to this heading">#</a></h3>
<p>The main components of the IO subsystem are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">file_manager.F90</span></code> : module providing dynamic management of unit numbers</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">io.F90</span></code> : interface providing a single entry point to IO for all UM executables.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">model_file.F90</span></code> : module which wraps some of the above commands for common operations such as opening and closing UM fieldsfiles.</p></li>
<li><p>A c-layer providing low-level access to reading/writing from/to disk.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ios.F90</span></code> : module providing client access to remote IO services.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ios_stash.F90</span></code> : module providing client access to pattern specific remote IO services, for fast handling of STASH of Dump requests.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">io_server_writer.F90</span></code>, <code class="docutils literal notranslate"><span class="pre">io_server_lister.F90</span></code>, <code class="docutils literal notranslate"><span class="pre">ios_queue.F90</span></code> : modules comprising the IO server itself.</p></li>
</ul>
</section>
</section>
<section id="data-flow">
<h2>Data flow<a class="headerlink" href="#data-flow" title="Link to this heading">#</a></h2>
<p>The Fortran IO module acts as a switch-box. The IO server tasks maintain a thread (OpenMP thread 0, or <em>T_0</em>) that maximises its availability for listening for inbound protocol messages. Any received messages and associated data payload is appended to an FIFO queue. The queue is a linked list of a Fortran derived data type <code class="docutils literal notranslate"><span class="pre">IOS_node_type</span></code>. The maximum queue length is the sum of all payloads attached to nodes, and any buffers set aside for receiving asynchronous STASH/dump data. <em>T_0</em> will exit its listen loop if it receives a termination message from <em>R_0</em> after placing it in the FIFO. The second of the IO sever <em>T_1</em> monitors the FIFO queue for objects to process. <em>T_1</em> exits its execution loop when the head of the queue contains the termination command.</p>
<p>Communication between <em>T_0</em> and <em>T_1</em> is via shared memory using a small number of scalar variables:</p>
<ul class="simple">
<li><p>The queue length</p></li>
<li><p>The number of items in the queue</p></li>
<li><p>Pointers to the head and tail of the queue.</p></li>
</ul>
<p>Correct flushing of such objects is critical to avoid deadlock situations. Extra threads, <em>T_n</em>, <em>n</em> &gt; 1 wait at the end of the main parallel section of <code class="docutils literal notranslate"><span class="pre">IOS_init()</span></code> until <em>T_0</em> and <em>T_1</em> have completed.</p>
</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Link to this heading">#</a></h2>
<section id="general-requirements">
<h3>General requirements<a class="headerlink" href="#general-requirements" title="Link to this heading">#</a></h3>
<p>To use IO servers:</p>
<ul class="simple">
<li><p>The application should be compiled with OpenMP.</p></li>
<li><p>The IO server should be configured to use at least two OpenMP threads. It should be possible to run the atmosphere model on any number of OpenMP threads.</p></li>
<li><p>The environment variable <code class="docutils literal notranslate"><span class="pre">FLUME_IOS_NPROCS</span></code> should be set to the total number of processes designated to be used as IO Servers. This value is computed as the number of servers required, multiplied by the size of each server (<code class="docutils literal notranslate"><span class="pre">IOS_tasks_per_server</span></code>). The number of IO servers that provide benefit will range between one and ten, after which adding more uses more resources without any additional benefit.</p></li>
</ul>
</section>
<section id="ioscntl-namelist">
<h3><code class="docutils literal notranslate"><span class="pre">IOSCNTL</span></code> namelist<a class="headerlink" href="#ioscntl-namelist" title="Link to this heading">#</a></h3>
<p>The IO server namelist <code class="docutils literal notranslate"><span class="pre">IOSCNTL</span></code> contains options for activation and configuration.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_Spacing</span></code> : Select the spacing of the IO servers. The servers are interleaved throughout the other processess with this periodicity.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_tasks_per_server</span></code> : How many MPI tasks will be used for each IO server. The total number of tasks used by the IO Server subsystem is this multiplied by the number of servers. <strong>The parallelism specified must be the same or less that the decomposition of the atmospheric model in the north south direction.</strong></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_Offset</span></code> : The number of tasks to skip before starting allocating IO Server tasks with the specified periodicity. If possible, <strong>set this such that IO servers are not allocated to nodes which include polar rows, as these generally have high communication costs already.</strong></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_force_threading_mode</span></code> : Force the model to behave assuming the threading model you specify. For experts only, will cause errors if the MPI implementation doesn’t conform to that specified. Useful for users confident their MPI implementation misreports its capabilities.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_buffer_size</span></code> : The maximum size (in MB) of the IO Sever’s FIFO queue. In general, bigger values will give improved performance, but take care not to oversubscribe the node’s total memory.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_concurrency_max_mem</span></code> : Maximum size (in MB) of the general purpose IO queue. Used only on <em>R_0</em>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_concurrency</span></code> : Number of IO operations queued on a client (<em>R_0</em>). Large values allow tolerance of delays in the IO servers responding to messages (usually caused by waiting for locks on the MPI library). Increasing this value increases memory usage on <em>R_0</em>. If accelerated STASH/Dumps are <strong>not</strong> enabled, the overhead will be roughly the size of a model level multiplied by the concurrency.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_backoff_interval</span></code> : The primary threads on the IO Servers use spin loops to wait for for work. Where threads share hardware resources (e.g. hyperthreading) the spin loop can slow down other threads. A larger polling interval makes checking the spin loops less aggressive, at the expense of latency (values is in microseconds)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_timeout</span></code> : The value in seconds that the model will wait for a message to complete.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_local_ro_files</span></code> : Because IO servers treat all operations in strict order opening, a read-only file on the IO server can result in waiting for other pending operations to complete. The user can instead opt for all read-only only files to be managed by <em>R_0</em>, bypassing IO servers.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_Unit_Alloc_Policy</span></code> : Static choices result in a fixed assignment for the run, while dynamic choices allows some units to be remapped by rotating the target server, by querying servers and selecting a lightly loaded one.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_rank_client_lb</span></code> : The atmospheric rank used for the load balancing using client info.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_queue_drain_rate</span></code> : The assumed rate of data drain (MiB/s) from an I/O server queue.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_Verbosity</span></code> : Sets an initial value for the level of printing output.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_num_threads</span></code> : Number of threads used by the I/O server. This may be different from the number used by the atmosphere. If so, extreme care must be taken to avoid thread binding.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_acquire_model_prsts</span></code> : Whether the above setting should be overridden by the general output specified for the main model.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_Interleave</span></code> : Whether the IO severs should be in sequential order or whether the tasks from different servers should interleave.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_serialise_mpi_calls</span></code> : Ensures MPI calls are called simultaneously on different threads on the same task.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_thread_0_calls_mpi</span></code> : Prohibits MPI calls on all threads except the first (<em>T_0</em>). <em>T_0</em> will proxy MPI calls needed by other threads.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_RelayToSlaves</span></code> : Selects how <em>R_0</em> sends command and control, together with metadata, to the members of a parallel IO server. The default treats all IO servers as peers, which can generate high messaging rates from <em>R_0</em> and high memory requirements. Selecting this option will send messages only to the first task in the team.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_Decomp_Model</span></code> : Selects how atmosphere tasks bind to members of a parallel IO Sever team.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_async_stats</span></code> : Will report details about communication sizes used by accelerated STASH/dump protocols.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_Lock_Meter</span></code>: Will report time waiting to access the MPI library and the shared memory FIFO queue on each thread. No time will be shown for MPI locks if the MPI library is multi-threaded.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_debug_no_write</span></code> : Turns off actual disk output of accelerated STASH operations.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_debug_no_packing</span></code> : Ignores the packing profile of accelerated STASH output and writes all data uncompressed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_debug_no_domaining</span></code> : Ignores the spatial profile of accelerated STASH output and writes full fields in all cases.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_together_end</span></code> : Resets the values of <code class="docutils literal notranslate"><span class="pre">IOS_Offset</span></code> and <code class="docutils literal notranslate"><span class="pre">IOS_Spacing</span></code> so the IO servers sit in a contiguous block at the end of the atmosphere MPI tasks. Useful when running setups which use rank reordering for the atmosphere.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_use_async_stash</span></code> : Chooses accelerated STASH method. These offer overall best performance.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_use_async_dump</span></code> :  Chooses accelerated Dump method. These offer overall best performance.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_async_levs_per_pack</span></code> : Selects the number of model levels to coalesce into a single transition with an IO server. Asynchronous model output will accumulate model levels to output until this threshold is reached. This gives fewer, larger messages b/w the model and IO servers at the expense of higher memory usage.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_as_concurrency</span></code> : Selects concurrency for accelerated STASH and dump methods. Works similarly to the general concurrency setting above, but for field data requests.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_async_send_null</span></code> : This includes null data results giving consistent message sizes, at the expense of larger bandwidth.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_use_helpers</span></code> : If the model has surplus OpenMP threads (i.e. more than two for an IO server) it allows them assist with low level I/O e.g. data fetch.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_enable_mpiio</span></code> : Allows STASH and Dump record writes to bypass low-level C IO interface and instead be written in parallel with MPI-IO semantics.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IOS_no_barrier_fileops</span></code> : When enabled, the last IO server that reaches the <code class="docutils literal notranslate"><span class="pre">IOS_Action_FileOp</span></code> sync point performs the action while other IO Servers can continue their work. Otherwise, the <code class="docutils literal notranslate"><span class="pre">IOS_Action_FileOp</span></code> is always performed by a specific IO Server which has to wait for all the other IO Servers to reach the sync point.</p></li>
</ul>
<p>In general, a server misconfiguration will result in the model executing without an IO servers active, and any MPI tasks assigned will idle for the duration of the program and IO will be performed by <em>R_0</em>.</p>
<p>Using an IO server perturbs the normal layout of the atmosphere processes, particularly output files from each process are named with its global rank, not the rank within the atmosphere model. Certain configurations may set the first task to be an IO server, will sends IO sever output to <code class="docutils literal notranslate"><span class="pre">*.leave</span></code> files.</p>
<p>Introducing IO servers changes the decomposition of atmospheric tasks, which will impact bit reproducibility.</p>
</section>
<section id="output-files">
<h3>Output files<a class="headerlink" href="#output-files" title="Link to this heading">#</a></h3>
<p>The stdout/Fortran unit 6 output files from IOS tasks are names consistently with the atmosphere files as <code class="docutils literal notranslate"><span class="pre">&lt;experiment&gt;.fort6.pe&lt;num&gt;</span></code> where <code class="docutils literal notranslate"><span class="pre">&lt;num&gt;</span></code> is the global MPI task rank. Changing IOS parameters will alter the file contents. <strong>In bad configurations, the output of rank zero may be from an IOS task and copied into the “leave” file.</strong></p>
<p>Additional files produced by IOS server tasks:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ioserver_log.&lt;num&gt;</span></code> where <code class="docutils literal notranslate"><span class="pre">&lt;num&gt;</span></code> is again the global rank. This file tracks memory use of the IO Server in three columns; time, queue size in words and change in queue size in words. <strong>The file can be loaded into gnuplot directly.</strong>, e.g. <code class="docutils literal notranslate"><span class="pre">plot</span> <span class="pre">ioserver_log.0031</span></code>.</p></li>
</ul>
</section>
</section>
<section id="setup-guide">
<h2>Setup Guide<a class="headerlink" href="#setup-guide" title="Link to this heading">#</a></h2>
<p>When setting up an IO server, be aware of the following conditions.</p>
<section id="domain-restrictions">
<h3>Domain restrictions<a class="headerlink" href="#domain-restrictions" title="Link to this heading">#</a></h3>
<p>When you assign processors to an I/O server, you will change the overall decomposition of your domain. You have to run the reconfiguration step every time you change the domain decomposition.</p>
<p>You assign the number of processors to the I/O servers by altering the <code class="docutils literal notranslate"><span class="pre">FLUME_IOS_NPROC</span></code> environment variable. Any non-zero value will trigger UM I/O logic and it will try to configure an I/O using the input environment variables and namelist inputs.</p>
<p>I’m fairly sure you must be using at least two OPENMP threads in the UM task (i.e. set <code class="docutils literal notranslate"><span class="pre">UM_ATM_OMP=2</span></code> in <code class="docutils literal notranslate"><span class="pre">site/nci-gadi/suite-adds.rc</span></code> for the rAM3 suite.)</p>
<p>The I/O namelist controls are located in <code class="docutils literal notranslate"><span class="pre">app/um/rose-app.conf</span></code> in the <code class="docutils literal notranslate"><span class="pre">[namelist:ioscntl]</span></code> section.</p>
<p>From the Bureau advice on suite optimisation <a class="reference external" href="https://code.metoffice.gov.uk/trac/nwpscience/wiki/bomnwpscience/AccessNWP_SuiteOptimisations">link at code.metoffice.gov.uk</a></p>
<blockquote>
<div><p>Gadi Cascade Lake nodes have 48 cores per node. Number of threads OMP_NUM_THREADS specified for a job should be set in a way that number of cores per node (48 is in the Cascade Lake case) is multiple of OMP_NUM_THREADS. The total number of cores used by a UM run is (NPROCX * NPROCY + FLUME_IOS_NPROC) * OMP_NUM_THREADS</p>
</div></blockquote>
<p>In our <code class="docutils literal notranslate"><span class="pre">suite.rc</span></code> files this is specified using</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">l</span> <span class="n">ncpus</span> <span class="o">=</span> <span class="p">{{(</span><span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span> <span class="o">+</span> <span class="n">ios</span><span class="p">)</span> <span class="o">*</span> <span class="n">omp</span><span class="p">}}</span>
</pre></div>
</div>
<p>The above link also suggests that</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">ios_spacing</span></code> – it is recommended that no more than a single IO server PE should be placed on each node, on Cascade Lake nodes with 48 cores per node it is achieved with ios_spacing=48/OMP_NUM_THREADS</p>
</div></blockquote>
<p>However, for the AUS2200 configuration running on the Sapphire Rapid nodes, the following configuration was used when running a 68x68 decomposition using 96 threads per node and .</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ios_spacing</span><span class="o">=</span><span class="mi">68</span>
</pre></div>
</div>
<p>Addittionally,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ios_tasks_per_server</span><span class="o">=</span><span class="mi">8</span>
</pre></div>
</div>
<p>was used because the AUS2200 model output six files (including the restart dump) at the end of the final timestep. So setting <code class="docutils literal notranslate"><span class="pre">FLUME_IOS_NCPROC</span> <span class="pre">=</span> <span class="pre">48</span></code> with 8 tasks per server allowed these six file writes to be written in parallel.</p>
<p>Investigation of the I/O server parameter settings for UM tasks on Gadi could prove fruitful.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="lbc.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Lateral Boundary Conditions</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#architecture">Architecture</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">IO Server</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lookup-tables-and-buffering-fieldsfiles">Lookup tables and buffering fieldsfiles</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#design">Design</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#components">Components</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-flow">Data flow</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">Configuration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#general-requirements">General requirements</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ioscntl-namelist"><code class="docutils literal notranslate"><span class="pre">IOSCNTL</span></code> namelist</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#output-files">Output files</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup-guide">Setup Guide</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#domain-restrictions">Domain restrictions</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By 21st Century Weather
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>